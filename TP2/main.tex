\documentclass[a4paper, 12pt, french]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{babel}[french]
\usepackage{amsmath,amssymb}
\usepackage{graphicx}
\usepackage{subfig}
\usepackage[colorinlistoftodos]{todonotes}
\usepackage{multicol}
\usepackage{indentfirst}
\usepackage{verbatim}
\usepackage{textcomp}
\usepackage{gensymb}
\usepackage{hyperref}
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
\usepackage{algorithmicx}
\usepackage{listingsutf8}
\usepackage{fancyhdr}
\definecolor{lightgray}{rgb}{.93,.94,.95}

\usepackage[T1]{fontenc}
\usepackage[scaled=0.85]{beramono}
\usepackage{listings}
\lstset{frameshape={RYR}{Y}{Y}{RYR},language=SQL,morekeywords={PREFIX,java,rdf,rdfs,url} extendedchars,
backgroundcolor=\color{lightgray},
showstringspaces=false, literate=%
		{'}{{'}}1 %permet l'écriture d'une apostrophe
		{é}{{\'e}}1
		{à}{{\`a}}1
		{ç}{{\c{c}}}1
		{œ}{{\oe}}1
		{ù}{{\`u}}1
		{É}{{\'E}}1
		{È}{{\`E}}1
		{À}{{\`A}}1
		{Ç}{{\c{C}}}1
		{Œ}{{\OE}}1
		{Ê}{{\^E}}1
		{ê}{{\^e}}1
		{î}{{\^i}}1
		{ô}{{\^o}}1
		{è}{{\`e}}1}


\usepackage{lineno}
\usepackage{float}
\usepackage{color}
\usepackage{lineno,hyperref}
\usepackage{ulem}
\setlength{\parindent}{0mm}
\usepackage{relsize}

\usepackage{lipsum}% http://ctan.org/pkg/lipsum
\usepackage{xcolor}% http://ctan.org/pkg/xcolor
\usepackage{xparse}% http://ctan.org/pkg/xparse
\NewDocumentCommand{\myrule}{O{1pt} O{2pt} O{black}}{%
  \par\nobreak % don't break a page here
  \kern\the\prevdepth % don't take into account the depth of the preceding line
  \kern#2 % space before the rule
  {\color{#3}\hrule height #1 width\hsize} % the rule
  \kern#2 % space after the rule
  \nointerlineskip % no additional space after the rule
}
\usepackage[section]{placeins}

\usepackage{pgfplots}
\pgfplotsset{compat=1.18}
\usepackage{booktabs}
\usepackage{tabularx}
\usepackage{seqsplit}
\usepackage{colortbl}%
   \newcommand{\myrowcolour}{\rowcolor[gray]{0.925}}
   
%\usepackage[obeyspaces]{url}
\usepackage{etoolbox}
%\usepackage[colorlinks,citecolor=black,urlcolor=blue,bookmarks=false,hypertexnames=true]{hyperref} 


\usepackage{geometry}
\geometry{
	paper=a4paper, % Change to letterpaper for US letter
	inner=3cm, % Inner margin
	outer=3cm, % Outer margin
	bindingoffset=.5cm, % Binding offset
	top=2cm, % Top margin
	bottom=2cm, % Bottom margin
	%showframe, % Uncomment to show how the type block is set on the page
}

\setlength{\headheight}{17.2pt}
\pagestyle{fancy}
\lhead{INF8085 Cybersécurité}
\rhead{Hiver 2026}
\renewcommand\footrulewidth{1pt}
\usepackage{listings}
\usepackage{color}
%*******************************************************************************%
\newcommand{\grando}[1]{O\mathopen{}\left(#1\right)}
%************************************START**************************************%
%*******************************************************************************%
\begin{document}

%*****************************TITLE PAGE*******************************%
\begin{titlepage}
\begin{center}
\textbf{\LARGE \'Ecole Polytechnique de Montr\'eal}\\[0.5cm] 
\textbf{\large D\'epartement de g\'enie informatique et g\'enie logiciel}\\[0.2cm]
\vspace{20pt}
\begin{figure}
 	\begin{center}	\includegraphics[width=90mm,scale=1.0]{images/poly.png}
	\end{center}
\end{figure}

\par
\vspace{20pt}
\vspace{15pt}
\myrule[1pt][7pt]
\textbf{\LARGE  Rapport du TP2}\\
\vspace{7pt}
\textbf{Cybersécurité}\\
\vspace{6pt}
\textbf{\large Travail pratique 2}\\
\myrule[1pt][7pt]

\vspace{25pt}

{\bfseries Fares Laadjel,} 2297799\\*[8pt]
{\bfseries Julien Cyr,} 2278776\\*[8pt]


\vspace{45pt}

\end{center}

\par
\vfill

\end{titlepage}





%********************************%
%***********  TOC  ************%
%********************************%
\tableofcontents
\newpage

%*******************************************************************************%
\section{Reconnaissance [/3]}
%*******************************************************************************%

Utilisez \texttt{nmap} pour scanner le serveur situé en 10.22.0.11. Identifiez les services et le système d'exploitation de la machine. Indiquez les captures d'écran des commandes utilisées et de leur sortie. Plus tard dans le TP, mettez à jour la liste si de nouveaux services apparaissent.

\vspace{0.8em}
\textit{Après avoir lancé la machine Kali et effectué un scan avec nmap sur 10.22.0.11 en ignorant le port 2222, deux services sont actuellement exposés.}

\medskip
\begin{sloppypar}
\textit{Le port 22/tcp est ouvert et exécute le service SSH. La version détectée est OpenSSH 8.9p1 sur Ubuntu. La machine permet des connexions distantes sécurisées et fonctionne sur une distribution Linux de type Ubuntu.}
\end{sloppypar}

\medskip
\textit{Le port 8080/tcp est ouvert et exécute un serveur web Apache 2.4.52 sur Ubuntu. Le scan révèle la présence d'une interface web menant vers une page de connexion login.php, ce qui suggère une application web avec authentification.}

\medskip
\textit{La détection du système d'exploitation indique un noyau Linux entre les versions 4.15 et 5.8. En combinant cette information avec les bannières des services, on peut conclure que la machine exécute probablement Ubuntu Linux.}

\begin{center}
\includegraphics[width=0.85\textwidth]{images/1-debut.png}
\end{center}

\medskip

\medskip
\textit{Après l'activation du service FTP depuis l'interface web, un nouveau scan nmap de 10.22.0.11 montre l'apparition d'un service supplémentaire sur le port 21. Le service détecté est un serveur FTP vsftpd en version 3.0.5.}

\medskip
\textit{Le scan indique aussi que l'accès FTP anonyme est autorisé. Une connexion sans identifiants permet de lister directement le contenu exposé. La liste retournée contient plusieurs fichiers du site, notamment index.php, login.php, functions.php, toggleService.php, submit\_ticket.php et view\_ticket.php. Cela confirme que le service FTP donne accès à des fichiers du code source de l'application.}

\medskip
\textit{La liste des services observés à ce stade comprend donc un service FTP sur le port 21, un service SSH sur le port 22 et un service web HTTP sur le port 8080.}

\begin{center}
\includegraphics[width=0.85\textwidth]{images/ftp.png}
\end{center}

%*******************************************************************************%
\section{Accès initial [/7]}
%*******************************************************************************%

%-------------------------------------------------------------------------------%
\subsection{Injection SQL sur la page de connexion [/1]}
%-------------------------------------------------------------------------------%
Montrez que la page de connexion est vulnérable aux injections SQL.

\vspace{0.8em}
\textit{En entrant simplement une quote dans le champ utilisateur (par exemple admin'), le serveur retourne une erreur SQL affichant la requête complète exécutée. Cette erreur montre que l'entrée utilisateur est insérée directement dans la requête :}
\begin{quote}
\texttt{SELECT * FROM users WHERE username = 'admin'' AND password = '...'}
\end{quote}
\textit{La présence d'une erreur de syntaxe causée par l'entrée utilisateur prouve que les données ne sont pas filtrées ni échappées correctement. Comme le contenu saisi modifie la structure de la requête SQL et provoque une erreur côté base de données, cela démontre que la page de connexion est vulnérable aux injections SQL.}

\begin{center}
\includegraphics[width=0.85\textwidth]{images/2.1.png}
\end{center}

%-------------------------------------------------------------------------------%
\subsection{Connexion par injection SQL [/2]}
%-------------------------------------------------------------------------------%
En utilisant une injection SQL, connectez-vous sur le site. Expliquez avec vos mots comment fonctionne votre attaque.

\vspace{0.8em}
\textit{La page de connexion est vulnérable aux injections SQL car les entrées utilisateur sont directement intégrées dans la requête SQL sans validation ni requêtes paramétrées. En entrant une chaîne spéciale contenant une quote et un commentaire SQL, il est possible de modifier la structure de la requête envoyée à la base de données. L'erreur SQL affichée par le serveur révèle la requête complète exécutée, ce qui prouve que l'entrée utilisateur est concaténée telle quelle dans le SQL. Cela permet de contourner la vérification du mot de passe et démontre une vulnérabilité d'injection SQL.}

\begin{center}
\includegraphics[width=0.85\textwidth]{images/2.2.png}
\end{center}

%-------------------------------------------------------------------------------%
\subsection{Injection XSS sur la page de tickets [/1]}
%-------------------------------------------------------------------------------%
Montrez que la page de soumission de tickets est vulnérable aux injections XSS.

\vspace{0.8em}
\textit{Un ticket a été soumis avec le champ Subject contenant le script suivant :}
\begin{center}
\texttt{<script>alert("TEST");</script>}
\end{center}
\textit{Après soumission, l'ouverture du ticket déclenche l'exécution du script dans le navigateur et une boîte de dialogue affiche TEST. Cela démontre que l'entrée utilisateur est enregistrée par le serveur puis réaffichée sans être filtrée, et qu'elle est exécutée côté client. La page de soumission de tickets est donc vulnérable à une XSS stockée.}

\begin{center}
\includegraphics[width=0.85\textwidth]{images/xss-1.png}\\[0.5em]
\includegraphics[width=0.85\textwidth]{images/xss-2.png}
\end{center}

%-------------------------------------------------------------------------------%
\subsection{Récupération des cookies admin par XSS [/2]}
%-------------------------------------------------------------------------------%
L'administratrice du système consulte régulièrement les tickets. Utilisez une injection XSS pour récupérer les cookies de son navigateur web.

\vspace{0.8em}
\textit{La page de soumission de tickets accepte du contenu HTML et Javascript sans filtrage. Il est donc possible d'y injecter un script qui sera stocké sur le serveur puis exécuté dans le navigateur de toute personne qui consulte le ticket. Cette vulnérabilité correspond à une XSS persistante.}

\medskip
\textit{Un ticket contenant le script malveillant a été soumis. Le script envoie la valeur de document.cookie vers un endpoint externe contrôlé par l'attaquant. Lorsque l'administratrice ouvre la page des tickets, son navigateur exécute automatiquement le script dans le contexte du site. Le cookie de session de l'administratrice est alors transmis vers le serveur externe, ce qui permet de le récupérer sans interaction supplémentaire. La réception du cookie est confirmée par la requête observée sur le service RequestBin.}

\medskip
\textit{Cette attaque fonctionne parce que le site affiche le contenu des tickets sans validation ni échappement, ce qui permet l'exécution de code arbitraire dans le navigateur d'un utilisateur authentifié.}

\begin{center}
\includegraphics[width=0.85\textwidth]{images/xss-script.png}\\[0.5em]
\includegraphics[width=0.85\textwidth]{images/xss-admin.png}
\end{center}

%-------------------------------------------------------------------------------%
\subsection{Connexion avec le cookie récupéré [/1]}
%-------------------------------------------------------------------------------%
En utilisant le cookie récupéré, connectez-vous au site web en tant qu'admin.

\vspace{0.8em}
\textit{Le cookie récupéré correspond à l'identifiant de session PHP de l'administratrice. Le mécanisme d'authentification du site repose uniquement sur ce cookie. Toute requête contenant un identifiant de session valide est considérée comme authentifiée par le serveur.}

\medskip
\textit{Le cookie de session local a été remplacé manuellement dans le navigateur par le cookie volé. Après rechargement de la page, le serveur associe le navigateur à la session existante de l'administratrice. Il est alors possible d'accéder directement à l'interface administrateur sans connaître son mot de passe.}

\medskip
\textit{Cette étape démontre une usurpation de session. La possession du cookie suffit à prendre le contrôle du compte, ce qui montre l'impact critique de la vulnérabilité XSS exploitée à l'étape précédente.}

\begin{center}
\includegraphics[width=0.85\textwidth]{images/xss-success.png}
\end{center}

%*******************************************************************************%
\section{Analyse en boîte blanche [/5]}
%*******************************************************************************%

\noindent\textit{Raccourci :} Mot de passe admin : \texttt{iL0veTrains\#78} si l'accès n'a pas été obtenu à la partie précédente.

%-------------------------------------------------------------------------------%
\subsection{Récupération du code source via FTP [/1]}
%-------------------------------------------------------------------------------%
Depuis l'application web, cliquez sur le bouton rouge pour allumer le service FTP. Connectez-vous au service FTP et récupérez le code source du site.

\vspace{0.8em}
\textit{Une connexion FTP vers 10.22.0.11 a été établie en utilisant le nom d'utilisateur anonymous sans mot de passe. Le serveur vsftpd 3.0.5 accepte cette connexion et donne accès en lecture au répertoire contenant les fichiers de l'application web. La commande \texttt{ls} permet de lister l'ensemble des fichiers exposés, incluant functions.php, index.php, login.php, logout.php, status.php, submit\_ticket.php, toggleService.php et view\_ticket.php, ainsi que des ressources statiques (icônes PNG).}

\medskip
\textit{L'ensemble des fichiers a été récupéré à l'aide de la commande \texttt{mget *}, qui télécharge tous les fichiers du répertoire courant. Le code source complet du site est ainsi obtenu localement sur la machine Kali.}

\begin{center}
\includegraphics[width=0.85\textwidth]{images/3.1.1.png}\\[0.5em]
\includegraphics[width=0.85\textwidth]{images/3.1.2.png}
\end{center}

%-------------------------------------------------------------------------------%
\subsection{Correction de la vulnérabilité FTP [/1]}
%-------------------------------------------------------------------------------%
Expliquez précisément comment corriger la vulnérabilité qui permet cette connexion FTP.

\vspace{0.8em}
\textit{La vulnérabilité provient du fait que le serveur FTP autorise les connexions anonymes. Toute personne sur le réseau peut donc se connecter sans identifiants et accéder directement aux fichiers exposés, incluant le code source de l'application. Cela facilite fortement l'analyse et l'exploitation de l'application.}

\medskip
\textit{La correction consiste à désactiver l'accès anonyme dans la configuration de vsftpd. Dans le fichier de configuration \texttt{/etc/vsftpd/vsftpd.conf}, l'option \texttt{anonymous\_enable} doit être réglée à \texttt{NO}. Après modification, le service FTP doit être redémarré pour appliquer la configuration.}

\medskip
\textit{En complément, l'accès FTP devrait être limité aux seuls utilisateurs autorisés via des comptes authentifiés, avec des permissions minimales sur les répertoires. Le répertoire contenant le code source de l'application ne devrait jamais être exposé publiquement via FTP. Une solution plus sécuritaire consiste à remplacer FTP par SFTP ou un mécanisme de déploiement interne afin d'éviter toute exposition inutile de fichiers sensibles.}

%-------------------------------------------------------------------------------%
\subsection{Correction de l'injection SQL dans le code PHP [/1]}
%-------------------------------------------------------------------------------%
Localisez dans le code PHP l'injection SQL exploitée dans la partie 4 et proposez une correction.

\vspace{0.8em}
\textit{L'injection SQL est dans le fichier login.php, dans le bloc qui traite le POST. Elle se situe à l'endroit où la requête est construite en concaténant directement \$username et \$password dans la chaîne SQL. La correction consiste à remplacer cette concaténation par une requête préparée.}

\begin{lstlisting}[language=PHP, basicstyle=\small\ttfamily, breaklines=true, frame=single]
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $username = $_POST['username'];
    $password = md5($_POST['password']);

    try {
        $stmt = $mysqli->prepare("SELECT * FROM users WHERE username = ? AND password = ?");
        if (!$stmt) {
            throw new Exception("Error: " . $mysqli->error);
        }

        $stmt->bind_param("ss", $username, $password);
        $stmt->execute();
        $result = $stmt->get_result();
    } catch (Exception $e) {
        echo $e->getMessage();
        exit;
    }

    if ($result->num_rows != 0) {
        $_SESSION['loggedin'] = true;
        $_SESSION['username'] = $username;
        header("location: index.php");
    } else {
        $showError = true;
    }
}
\end{lstlisting}

%-------------------------------------------------------------------------------%
\subsection{Mécanisme de basculement des services [/2]}
%-------------------------------------------------------------------------------%
En vous basant sur le code source PHP et Javascript de l'application web, expliquez précisément le fonctionnement du mécanisme qui permet de basculer l'état des services.

\vspace{0.8em}
\medskip
\textit{Le tableau de bord lance automatiquement une mise à jour périodique via Javascript. La fonction updateStatus crée une requête HTTP GET vers le script status.php chaque seconde. La réponse est du JSON. Ce JSON contient l'état des services web, ftp et ssh, ainsi que le uptime. Le code Javascript parse la réponse puis met à jour les éléments de la page en ajustant les classes CSS des indicateurs. Les classes running, stopped et notfound déterminent la couleur affichée.}

\medskip
\textit{Le basculement de l'état se fait au clic sur un indicateur. Chaque bouton appelle toggleService avec un identifiant de service prédéfini dans le onclick, par exemple apache2, vsftpd ou ssh. toggleService envoie ensuite une requête HTTP GET vers toggleService.php en ajoutant le paramètre service dans l'URL.}

\medskip
\textit{Côté PHP, toggleService.php commence par vérifier que la session existe et que l'utilisateur est authentifié. Ensuite, une vérification supplémentaire impose que l'utilisateur soit admin. Si ce n'est pas admin, le script répond immédiatement avec un JSON qui indique un échec et un message.}

\medskip
\textit{Si l'utilisateur est admin, le script récupère le paramètre service depuis la requête. Il appelle checkServiceStatus depuis functions.php pour déterminer si le service est running ou non. Selon le statut, le script exécute une commande système via shell\_exec en envoyant soit start soit stop vers le programme /usr/bin/controller, en lui passant le nom du service. La sortie de cette commande est placée dans un objet JSON success true et renvoyée au navigateur.}

\medskip
\textit{Enfin, côté Javascript, la requête de basculement ne met pas directement à jour les pastilles. L'affichage est rafraîchi par les appels périodiques à status.php, ce qui reflète l'état réel après l'action.}

%*******************************************************************************%
\section{Compromission d'un compte utilisateur [/4]}
%*******************************************************************************%

%-------------------------------------------------------------------------------%
\subsection{Récupération du hash de carol par injection SQL [/2]}
%-------------------------------------------------------------------------------%
En utilisant une injection SQL, récupérez le hash du mot de passe de carol.

\vspace{0.8em}
\noindent\textit{Votre réponse ici.}
\begin{center}
% Insérer capture d'écran
\end{center}

%-------------------------------------------------------------------------------%
\subsection{Craquage du hash [/1]}
%-------------------------------------------------------------------------------%
Cassez le hash pour obtenir le mot de passe de carol. Indice : le mot de passe est composé uniquement de 6 chiffres.

\vspace{0.8em}
\noindent\textit{Votre réponse ici.}
\begin{center}
% Insérer capture d'écran
\end{center}

%-------------------------------------------------------------------------------%
\subsection{Récupération de controller.c via SSH [/1]}
%-------------------------------------------------------------------------------%
Connectez-vous en SSH au compte de carol, et récupérez le fichier \texttt{controller.c}.

\vspace{0.8em}
\noindent\textit{Votre réponse ici.}
\begin{center}
% Insérer capture d'écran
\end{center}

%*******************************************************************************%
\section{Élévation de privilèges [/6]}
%*******************************************************************************%

\noindent\textit{Raccourci :} Le fichier \texttt{controller.c} est disponible sur Moodle si non obtenu à la partie précédente.

%-------------------------------------------------------------------------------%
\subsection{Shell www-data par injection de commande PHP [/2]}
%-------------------------------------------------------------------------------%
Utilisez une injection de commande PHP dans le mécanisme qui permet de basculer l'état des services pour obtenir un shell en tant que \texttt{www-data}.

\vspace{0.8em}
\noindent\textit{Votre réponse ici.}
\begin{center}
% Insérer capture d'écran
\end{center}

%-------------------------------------------------------------------------------%
\subsection{Analyse de controller.c et vulnérabilité buffer overflow [/2]}
%-------------------------------------------------------------------------------%
Que fait le programme \texttt{controller.c}~? Identifiez une vulnérabilité causée par un débordement de tampon et expliquez comment la corriger.

\vspace{0.8em}
\noindent\textit{Votre réponse ici.}

%-------------------------------------------------------------------------------%
\subsection{Exploitation du buffer overflow pour devenir root [/2]}
%-------------------------------------------------------------------------------%
Exploitez le dépassement de tampon dans le programme \texttt{controller} et devenez root.

\vspace{0.8em}
\noindent\textit{Votre réponse ici.}
\begin{center}
% Insérer capture d'écran
\end{center}

%*******************************************************************************%
\section{Accès physique = Game Over [3 points bonus]}
%*******************************************************************************%

Obtenez un shell root sur la machine virtuelle TP2.

\vspace{0.8em}
\noindent\textit{Votre réponse ici.}

\newpage


%*******************************************************************************%
\section*{Bibliographie}
%*******************************************************************************%
\addcontentsline{toc}{section}{Bibliographie}
Indiquez toutes vos sources d'information (humaines ou documentaires).

\begin{thebibliography}{99}
% Ajoutez vos sources (nmap, SQL injection, XSS, sqlmap, hashcat, vsftpd, gdb, etc.)
\bibitem{nmap} nmap -- Network Mapper. \url{https://nmap.org/}
\end{thebibliography}

\end{document}
